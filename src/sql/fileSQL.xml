<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="bengineer">
	<select id="getref" resultType="int" parameterType="fileDTO">
		select num from BEfilelist where orgname = #{orgname} and folder_ref = #{folder_ref}
	</select>
	<select id="getfiles" resultType="fileDTO" parameterType="int">
		select * from BEfilelist where folder_ref = #{folder_ref} order by filetype desc, filename asc
	</select>
	<insert id="makebasedir" parameterType="fileDTO">
		insert into BEfilelist(num,folder_ref,filename,orgname,filetype,uploaddate,updatedate,important,owner) values(BEfilelist_seq.NEXTVAL, #{folder_ref}, #{filename}, #{orgname}, 'dir', sysdate, sysdate, -1, #{owner})
	</insert>
	<insert id="makedir" parameterType="fileDTO">
		insert into BEfilelist(num,folder_ref,filename,orgname,filetype,uploaddate,updatedate,owner) values(BEfilelist_seq.NEXTVAL, #{folder_ref}, #{filename}, #{orgname}, 'dir', sysdate, sysdate, #{owner})
	</insert>
	<select id="getaddr" resultType="fileDTO" parameterType="int">
		select * from BEfilelist where num = #{folder_ref}
	</select>
	<insert id="upload" parameterType="fileDTO">
		insert into BEfilelist(num, folder_ref, filename, orgname, filetype, filesize, uploaddate, updatedate, owner) values(BEfilelist_seq.NEXTVAL, #{folder_ref}, #{filename}, #{orgname}, #{filetype}, #{filesize}, sysdate, sysdate, #{owner})
	</insert>
	<update id="changename" parameterType="fileDTO">
		update BEfilelist set filename = #{filename}, orgname = #{orgname}, updatedate = sysdate where num = #{num}
	</update>
	<select id="checksharekey" resultType="int" parameterType="String">
		select count(*) from BEkeylist where share_key = #{code}
	</select>
	<update id="hit" parameterType="int">
		update BEfilelist set hitcount = hitcount + 1 where num = #{file_ref}
	</update>
	<update id="updatefile" parameterType="fileDTO">
		update BEfilelist set filename = #{filename}, filesize = #{filesize}, updatedate = sysdate where folder_ref = #{folder_ref} and orgname = #{orgname}
	</update>
	<select id="open" parameterType="string" resultType="keyDTO">
		select * from BEkeylist where share_key = #{share_key}
	</select>
	<insert id="getsharedfile" parameterType="shareDTO">
		insert into BEsharelist(num, share_key, id) values(BEsharelist_seq.NEXTVAL, #{share_key}, #{id})
	</insert>
	<select id="keycheck" parameterType="keyDTO" resultType="string">
		select share_key from BEkeylist where filenum = #{filenum} and enddate = #{enddate} and rw = #{rw}
	</select>
	<insert id="insertkey" parameterType="keyDTO">
		insert into BEkeylist(share_key, filenum, enddate, rw) values(#{share_key}, #{filenum}, #{enddate}, #{rw})
	</insert>
	<select id="getkey" parameterType="shareDTO" resultType="keyDTO">
		select b.share_key share_key, b.filenum filenum, b.enddate enddate, b.rw rw from BEsharelist a inner join BEkeylist b on a.share_key = b.share_key where a.id = #{id} and b.filenum = #{num} and b.enddate >= sysdate
	</select>
	<select id="mysharedfile" parameterType="string" resultType="fileDTO">
		select * from BEfilelist where num in (select b.filenum from BEsharelist a inner join BEkeylist b on a.share_key = b.share_key where a.id = #{id} and b.enddate >= sysdate)
	</select>
	<delete id="deletefile" parameterType="int">
		delete from BEfilelist where num = #{folder_ref}
	</delete>
	<select id="getparentnum" parameterType="hashmap" resultType="int">
		select num from BEfilelist where owner = #{owner} and important = -1 and orgname = #{orgname}
	</select>
	<update id="autoarrange" parameterType="fileDTO">
		update BEfilelist set folder_ref = #{num} where owner = #{owner} and orgname = #{orgname}
	</update>
</mapper>